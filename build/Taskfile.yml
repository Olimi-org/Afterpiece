version: "3"

tasks:
  setup:
    summary: Sets up build environment
    cmds:
      - mise install
      - go mod download
      - mkdir -p {{.BIN_DIR}}
      - mkdir -p runtimes

  go:mod:tidy:
    summary: Runs go mod tidy
    internal: true
    cmds:
      - go mod tidy

  generate:bindings:
    summary: Generates code bindings
    deps:
      - task: go:mod:tidy
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    cmds:
      - go generate ./...

  test:unit:
    summary: Runs unit tests
    deps:
      - task: setup
    cmds:
      - go test -tags=dev_build ./...

  lint:go:
    summary: Runs Go linters
    cmds:
      - golangci-lint run

  fmt:go:
    summary: Formats Go code
    cmds:
      - go fmt ./...
      - goimports -w .

  build:platform:
    summary: Builds for a specific platform and arch
    internal: true
    vars:
      EXE_SUFFIX: '{{if eq .PLATFORM "windows"}}.exe{{end}}'
      DIST_DIR: "{{.BIN_DIR}}/{{.APP_NAME}}-{{.PLATFORM}}-{{.ARCH}}"
    deps:
      - task: build:components
        vars:
          PLATFORM: "{{.PLATFORM}}"
          ARCH: "{{.ARCH}}"
          EXE_SUFFIX: '{{if eq .PLATFORM "windows"}}.exe{{end}}'
    cmds:
      - mkdir -p {{.DIST_DIR}}/bin
      - CGO_ENABLED=0 GOOS={{.PLATFORM}} GOARCH={{.ARCH}} go build -ldflags="-s -w -X encr.dev/internal/version.Version={{.VERSION}}" -trimpath -o {{.DIST_DIR}}/bin/{{.APP_NAME}}{{.EXE_SUFFIX}} {{.CLI_PACKAGE}}
      - mv {{.BIN_DIR}}/git-remote-{{.APP_NAME}}-{{.PLATFORM}}-{{.ARCH}}{{.EXE_SUFFIX}} {{.DIST_DIR}}/bin/git-remote-{{.APP_NAME}}{{.EXE_SUFFIX}} 2>/dev/null || true
      - mv {{.BIN_DIR}}/tsbundler-{{.APP_NAME}}-{{.PLATFORM}}-{{.ARCH}}{{.EXE_SUFFIX}} {{.DIST_DIR}}/bin/tsbundler-{{.APP_NAME}}{{.EXE_SUFFIX}} 2>/dev/null || true
      - mv {{.BIN_DIR}}/sqlc{{.EXE_SUFFIX}} {{.DIST_DIR}}/bin/sqlc{{.EXE_SUFFIX}} 2>/dev/null || true
      - cp -r {{.GO_RUNTIME}}/* {{.DIST_DIR}}/{{.GO_RUNTIME}}/ 2>/dev/null || true
      - mkdir -p {{.DIST_DIR}}/runtimes/
      - cp -r runtimes/* {{.DIST_DIR}}/runtimes/ 2>/dev/null || true
      - cp LICENSE* {{.DIST_DIR}}/ 2>/dev/null || true
      - cp README* {{.DIST_DIR}}/ 2>/dev/null || true
      - 'if [ "{{.PLATFORM}}" != "darwin" ]; then upx --best {{.DIST_DIR}}/bin/*{{.EXE_SUFFIX}}; fi'

  build:components:
    summary: Builds git-remote and tsbundler for a platform
    internal: true
    vars:
      EXE_SUFFIX: '{{if eq .PLATFORM "windows"}}.exe{{end}}'
    cmds:
      - |
        echo "Building {{.PLATFORM}} components for {{.ARCH}}..."
        CGO_ENABLED=0 GOOS={{.PLATFORM}} GOARCH={{.ARCH}} go build -trimpath -o {{.BIN_DIR}}/git-remote-{{.APP_NAME}}-{{.PLATFORM}}-{{.ARCH}}{{.EXE_SUFFIX}} {{.GIT_REMOTE_PACKAGE}}
        CGO_ENABLED=0 GOOS={{.PLATFORM}} GOARCH={{.ARCH}} go build -trimpath -o {{.BIN_DIR}}/tsbundler-{{.APP_NAME}}-{{.PLATFORM}}-{{.ARCH}}{{.EXE_SUFFIX}} {{.TSBUNDLER_PACKAGE}}